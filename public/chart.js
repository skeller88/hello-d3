// 446 x 333
var data = [
    {
        "top_conditions": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": "depression", "count": 108},
                    {"_id": "fibromyalgia", "count": 99},
                    {"_id": "anxiety", "count": 87},
                    {"_id": "migraine", "count": 81},
                    {"_id": "chronic fatigue syndrome", "count": 75},
                    {"_id": "ehlers-danlos syndrome", "count": 70},
                    {"_id": "irritable bowel syndrome", "count": 68},
                    {"_id": "crohn's disease", "count": 61},
                    {"_id": "asthma", "count": 58},
                    {"_id": "hashimoto's thyroiditis", "count": 55}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": "depression", "count": 158},
                    {"_id": "fibromyalgia", "count": 148},
                    {"_id": "migraine", "count": 140},
                    {"_id": "anxiety", "count": 135},
                    {"_id": "chronic fatigue syndrome", "count": 130},
                    {"_id": "ehlers-danlos syndrome", "count": 121},
                    {"_id": "crohn's disease", "count": 104},
                    {"_id": "irritable bowel syndrome", "count": 95},
                    {"_id": "hashimoto's thyroiditis", "count": 91},
                    {"_id": "hypothyroidism", "count": 88}
                ]
            }
        ]
    },
    {
        "n_conditions": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": 0,  "count": 56},
                    {"_id": 1,  "count": 101},
                    {"_id": 2,  "count": 154},
                    {"_id": 3,  "count": 132},
                    {"_id": 4,  "count": 89},
                    {"_id": 5,  "count": 65},
                    {"_id": 6,  "count": 45},
                    {"_id": 7,  "count": 30},
                    {"_id": 8,  "count": 21},
                    {"_id": 9,  "count": 15},
                    {"_id": 10, "count": 5},
                    {"_id": 11, "count": 3},
                    {"_id": 12, "count": 2},
                    {"_id": 14, "count": 1},
                    {"_id": 19, "count": 1}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": 0,  "count": 84},
                    {"_id": 1,  "count": 161},
                    {"_id": 2,  "count": 144},
                    {"_id": 3,  "count": 162},
                    {"_id": 4,  "count": 101},
                    {"_id": 5,  "count": 85},
                    {"_id": 6,  "count": 55},
                    {"_id": 7,  "count": 51},
                    {"_id": 8,  "count": 41},
                    {"_id": 9,  "count": 20},
                    {"_id": 10, "count": 14},
                    {"_id": 11, "count": 10},
                    {"_id": 12, "count": 6},
                    {"_id": 13, "count": 2},
                    {"_id": 14, "count": 1},
                    {"_id": 18, "count": 1},
                    {"_id": 21, "count": 1},
                    {"_id": 25, "count": 1}
                ]
            }
        ]
    },
    {
        "top_symptoms": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": "fatigue", "count": 178},
                    {"_id": "headache", "count": 102},
                    {"_id": "brain fog", "count": 81},
                    {"_id": "anxiety", "count": 78},
                    {"_id": "joint pain", "count": 71},
                    {"_id": "pain", "count": 65},
                    {"_id": "nausea", "count": 60},
                    {"_id": "diarrhea", "count": 58},
                    {"_id": "depression", "count": 51},
                    {"_id": "dizziness", "count": 50}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": "fatigue", "count": 178},
                    {"_id": "headache", "count": 102},
                    {"_id": "brain fog", "count": 81},
                    {"_id": "pain", "count": 78},
                    {"_id": "joint pain", "count": 71},
                    {"_id": "anxiety", "count": 65},
                    {"_id": "nausea", "count": 60},
                    {"_id": "diarrhea", "count": 58},
                    {"_id": "depression", "count": 51},
                    {"_id": "dizziness", "count": 50}
                ]
            }
        ]
    },
    {
        "n_symptoms": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": 0,  "count": 30},
                    {"_id": 1,  "count": 151},
                    {"_id": 2,  "count": 144},
                    {"_id": 3,  "count": 110},
                    {"_id": 4,  "count": 88},
                    {"_id": 5,  "count": 63},
                    {"_id": 6,  "count": 40},
                    {"_id": 7,  "count": 32},
                    {"_id": 8,  "count": 21},
                    {"_id": 9,  "count": 15},
                    {"_id": 10, "count": 5},
                    {"_id": 12, "count": 2},
                    {"_id": 14, "count": 1},
                    {"_id": 16, "count": 1},
                    {"_id": 25, "count": 1}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": 0,  "count": 44},
                    {"_id": 1,  "count": 131},
                    {"_id": 2,  "count": 184},
                    {"_id": 3,  "count": 202},
                    {"_id": 4,  "count": 141},
                    {"_id": 5,  "count": 89},
                    {"_id": 6,  "count": 54},
                    {"_id": 7,  "count": 52},
                    {"_id": 8,  "count": 41},
                    {"_id": 9,  "count": 20},
                    {"_id": 10, "count": 14},
                    {"_id": 11, "count": 10},
                    {"_id": 12, "count": 6},
                    {"_id": 13, "count": 2},
                    {"_id": 18, "count": 1},
                    {"_id": 21, "count": 1},
                    {"_id": 25, "count": 1},
                    {"_id": 27, "count": 1},
                    {"_id": 35, "count": 1}
                ]
            }
        ]
    },
    {
        "top_treatments": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": "exercise", "count": 75},
                    {"_id": "magnesium", "count": 69},
                    {"_id": "vitamin d", "count": 61},
                    {"_id": "ibuprofen", "count": 57},
                    {"_id": "gluten free", "count": 53},
                    {"_id": "yoga", "count": 53},
                    {"_id": "dairy free", "count": 51},
                    {"_id": "sleep", "count": 46},
                    {"_id": "fish oil", "count": 45},
                    {"_id": "gabapentin", "count": 41}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": "vitamin d", "count": 91},
                    {"_id": "exercise", "count": 88},
                    {"_id": "magnesium", "count": 85},
                    {"_id": "ibuprofen", "count": 81},
                    {"_id": "meditation", "count": 71},
                    {"_id": "gluten free", "count": 66},
                    {"_id": "dairy free", "count": 50},
                    {"_id": "yoga", "count": 48},
                    {"_id": "fish oil", "count": 45},
                    {"_id": "sleep", "count": 44}
                ]
            }
        ]
    },
    {
        "n_treatments": [
            {
                "groupBy": {"sex": "male"},
                "values": [
                    {"_id": 0,  "count": 78},
                    {"_id": 1,  "count": 131},
                    {"_id": 2,  "count": 155},
                    {"_id": 3,  "count": 112},
                    {"_id": 4,  "count": 80},
                    {"_id": 5,  "count": 64},
                    {"_id": 6,  "count": 42},
                    {"_id": 7,  "count": 31},
                    {"_id": 8,  "count": 23},
                    {"_id": 9,  "count": 15},
                    {"_id": 10, "count": 3},
                    {"_id": 11, "count": 5},
                    {"_id": 12, "count": 2},
                    {"_id": 15, "count": 1},
                    {"_id": 19, "count": 1},
                    {"_id": 30, "count": 1}
                ]
            },
            {
                "groupBy": {"sex": "female"},
                "values": [
                    {"_id": 0,  "count": 94},
                    {"_id": 1,  "count": 201},
                    {"_id": 2,  "count": 124},
                    {"_id": 3,  "count": 112},
                    {"_id": 4,  "count": 105},
                    {"_id": 5,  "count": 81},
                    {"_id": 6,  "count": 58},
                    {"_id": 7,  "count": 51},
                    {"_id": 8,  "count": 43},
                    {"_id": 9,  "count": 19},
                    {"_id": 10, "count": 14},
                    {"_id": 11, "count": 5},
                    {"_id": 12, "count": 3},
                    {"_id": 13, "count": 2},
                    {"_id": 14, "count": 1},
                    {"_id": 18, "count": 1},
                    {"_id": 21, "count": 1},
                    {"_id": 25, "count": 1},
                    {"_id": 47, "count": 1}
                ]
            }
        ]
    }
];


// Chart settings
var width = 446;
var height = 333;
var outerMargin = {
    top: 10,
    right: 30,
    bottom: 30,
    left: 40
};
var axisLabelMargin = {
    x: 7,
    y: 3
}
var innerWidth = width - outerMargin.left - outerMargin.right;
var innerHeight = height - outerMargin.top - outerMargin.bottom;

/**
 * Chart difference between two groups in counts of symptoms, conditions, or treatments.
 * @param dataObj {object} the two groups of data wrapped in an object
 * @param field {string} 'sex', 'age'
 * @param baselineName {string} baseline group name
 * @param comparisonName {string} group to compare against baseline
 * @param binSize {int} size of histogram bin
 */
function chartCounts(dataObj, field, baselineName, comparisonName, binSize) {
    var chartTypes = {
        'n_conditions': 'conditions',
        'n_symptoms': 'symptoms',
        'n_treatments': 'treatments'
    };


    function getChartType(dataObj) {
        var chartTypeKeys = Object.keys(chartTypes);

        for (var i = 0; i < chartTypeKeys.length; i++) {
            if (dataObj[chartTypeKeys[i]] != undefined) {
                return chartTypeKeys[i];
            }
        }
    }

    // look up the proper key in data
    var chartType = getChartType(dataObj);
    // populate chart title and x axis
    var chartTypeName = chartTypes[chartType];
    var data = dataObj[chartType];
    var firstGroupName = data[0].groupBy[field];
    var secondGroupName = data[1].groupBy[field];

    // Chart options
    var binSize = binSize || 2;
    var title = 'Number of ' + chartTypeName + ': comparing ' + comparisonName + ' against ' + baselineName + ' baseline';
    var xLabel = 'Number of ' + chartTypeName;
    var yLabel = 'Count difference';

    if (firstGroupName === baselineName && secondGroupName === comparisonName) {
        var baselineData = data[0].values;
        var comparisonData = data[1].values;
    } else if (firstGroupName === comparisonName && secondGroupName === baselineName) {
        var baselineData = data[1].values;
        var comparisonData = data[0].values;
    } else {
        console.error('Expected baseline group name and comparison group name do not match the data\'s group names.');
    }

    // Munge to compute diffs
    // {1 : 300, 2: 30, 4: 50}
    var diffDataRecord = {};
    comparisonData.forEach(function(obj) {
        diffDataRecord[obj._id] = obj.count;
    });

    // {1: -30, 2: 20, 3: -100, 4: 0}
    baselineData.forEach(function(obj) {
        var comparisonCount = diffDataRecord[obj._id];

        if (comparisonCount === undefined) {
            console.warn('Found baseline _id with no matching comparison _id:', obj._id);
            diffDataRecord[obj._id] = 0 - obj.count;
        } else {
            diffDataRecord[obj._id] = comparisonCount - obj.count;
        }
    });

    var extent = d3.extent(baselineData.concat(comparisonData), function(d) {
        // value of "_id" is the "number of conditions/symptoms/treatments". The value type is String.
        return parseInt(d._id);
    });
    var min = extent[0];
    // histograms in R hist() are left-open and right-closed by default.
    var max = extent[1];
    var numBins = ((max + 1 - min) / binSize);

    // object --> array of binned objects
    // {1: -30, 2: 20, 3: -100, 4: 0} --> [{bin: 0, diff: -30}, {bin: 2, diff: -80}, {bin: 4, diff:0}]
    var histData = [];
    var currentBin = min;

    for (var binNum = 0; binNum < numBins; binNum++) {
        var binDiffCount = 0;

        for (var i = currentBin; i < currentBin + binSize; i++) {
            if (diffDataRecord[i] != undefined) {
                binDiffCount += diffDataRecord[i];
            }
        }

        histData.push({bin: currentBin, diff: binDiffCount});
        currentBin += binSize;
    }

    var diffExtent = d3.extent(histData, function(d) { return d.diff; });
    var minDiff = diffExtent[0];
    var maxDiff = diffExtent[1];
    
    console.log(histData);


    // This scale is for determining the widths of the histogram bars
    // Must start at 0 or else x (bin size a.k.a dx) will be negative

    // Scale for the placement of the bars
    var xPositionScale = d3.scale.linear()
        .domain([min, max])
        .range([outerMargin.left, innerWidth]);

    var yScale = d3.scale.linear()
        .domain([minDiff, maxDiff])
        .range([height - outerMargin.bottom, outerMargin.top]);

    var xAxis = d3.svg.axis()
        .scale(xPositionScale)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("left");

    var svg = d3.select("body").append("svg")
        .attr("width", width + outerMargin.left + outerMargin.right)
        .attr("height", height + outerMargin.top + outerMargin.bottom)
        .append("g")
        .attr("transform", "translate(" + outerMargin.left + "," + outerMargin.top + ")");

    // Change if we decide to not make all bins the same width
    var renderedBinWidth = Math.abs(xPositionScale(binSize) - xPositionScale(0));
    var bar = svg.selectAll(".bar")
        .data(histData)
        .enter().append("rect")
        .attr("class", function(d) { return d.diff < 0 ? "bar negative" : "bar positive"; })
        .attr('x', function(d) {
            return xPositionScale(d.bin);
        })
        .attr("y", function(d) { return yScale(Math.max(0, d.diff)); })
        .attr('width', renderedBinWidth)
        .attr("height", function(d) { return Math.abs(yScale(d.diff) - yScale(0)); });

    svg.append("line")
        .attr("class", "baseline")
        .attr("y1", yScale(0))
        .attr("y2", yScale(0))
        .attr("x1", outerMargin.left)
        .attr("x2", innerWidth);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0, " + (height - outerMargin.bottom) + ")")
        .call(xAxis)
        .append('text')
        .attr('class', 'x-label label')
        .attr('transform', 'translate(' + (innerWidth/2) + ',' + (outerMargin.bottom + axisLabelMargin.x) + ')')
        .text(xLabel);

    svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (outerMargin.left) + ", 0)")
        .call(yAxis)
        .append('text')
        .attr('class', 'y-label label')
        .attr('transform', 'translate(' + -(outerMargin.left + axisLabelMargin.y) +',' + height/2 + ') rotate(' + (-90) + ')')
        .text(yLabel);

    svg.append('g')
        .append('h4')
        // Example: "Number of conditions: comparing male against female baseline"
        .text(title);
}

chartCounts(data[1], 'sex', 'male', 'female');
chartCounts(data[3], 'sex', 'male', 'female');
chartCounts(data[5], 'sex', 'male', 'female');

//chartCounts(data[1], 'sex', 'female', 'male');
//chartCounts(data[3], 'sex', 'female', 'male');
//chartCounts(data[5], 'sex', 'female', 'male');